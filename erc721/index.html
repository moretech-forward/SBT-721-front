<body id="itrf">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link
    href="https://cdn.jsdelivr.net/npm/daisyui@4.10.2/dist/full.min.css"
    rel="stylesheet"
    type="text/css"
  />
  <link
    href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css"
    rel="stylesheet"
    type="text/css"
  />

  <link href="./output.css" rel="stylesheet" />

  <p id="future_address" class="hidden invisible"></p>
  <div class="p-2 hidden invisible">
    <div class="accordion">
      <div class="accordion-item">
        <section class="m-auto w-100">
          <h3 id="headingOne" class="accordion-header text-center">
            <button
              type="button"
              data-bs-toggle="collapse"
              data-bs-target="#collapse_myAddr"
              aria-expanded="true"
              aria-controls="collapse_myAddr"
              class="accordion-button collapsed"
            >
              myAddr
            </button>
          </h3>
          <div
            id="collapse_myAddr"
            aria-labelledby="headingOne"
            data-bs-parent="#accordionExample"
            class="accordion-collapse collapse"
          >
            <div class="accordion-body">
              <form id="form-myAddr" class="d-flex flex-column gap-2 p-2">
                <div>
                  <button
                    id="btn"
                    type="button"
                    data-form-name="myAddr"
                    class="btn btn-primary mt-2"
                  >
                    Read
                  </button>
                </div>
                <div>
                  <p>Response:</p>
                  <div>
                    :
                    <span
                      id="form-output-myAddr-0"
                      data-form-name="myAddr"
                      data-field-type="address"
                      >address</span
                    >
                    <br />
                  </div>
                </div>

                <script>
                  setTimeout(() => {
                    const element = document.getElementById("btn");
                    if (element) {
                      element.click();

                      setTimeout(() => {
                        const future_address =
                          document.getElementById("future_address");
                        future_address.innerHTML = document.getElementById(
                          "form-output-myAddr-0"
                        ).innerHTML;
                      }, 1000);
                    }
                  }, 1000);
                </script>
              </form>
            </div>
          </div>
        </section>
      </div>
    </div>
  </div>

  <div
    class="bg-base-100 w-full flex flex-col items-center gap-4 pt-36"
    id="loader"
    style="min-height: 800px"
    data-theme="dark"
  >
    <span class="loading loading-ring loading-lg text-white"></span>
    <p class="text-white text-3xl" id="init-text"></p>
  </div>

  <section
    data-theme="dark"
    id="content"
    class="pt-20 flex items-center flex-col gap-10 min-h-screen bg-base-100 hidden"
  >
    <br />
    <h1 class="text-center text-3xl font-extrabold text-white">
      Soulbound Token (ERC721)
    </h1>
    <div role="tablist" class="tabs tabs-boxed">
      <a
        role="tab"
        id="nft-tab"
        class="tab tab-active transition-all duration-200"
      >
        All NFT
      </a>
    </div>
    <div
      id="nft-cards"
      class="mx-auto px-[20px] max-w-[1170px] grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6"
    ></div>
  </section>

  <script
    src="https://cdn.ethers.io/lib/ethers-5.2.umd.min.js"
    type="application/javascript"
  ></script>
  <script
    src="https://cdn.jsdelivr.net/npm/toastify-js"
    type="text/javascript"
  ></script>
  <script src="https://unpkg.com/typed.js@2.1.0/dist/typed.umd.js"></script>
  <!--loading animation-->
  <script>
    const loader = document.getElementById("loader");
    const content = document.getElementById("content");

    var typed = new Typed("#init-text", {
      strings: ["Initializing app...", "Get contract info..."],
      typeSpeed: 30,
      backSpeed: 0,
    });

    setTimeout(() => {
      loader.classList.remove("flex");
      loader.classList.add("hidden");

      content.classList.remove("hidden");
    }, 3000);
  </script>
  <script>
    const abi = [
      "constructor(string _name, string _symbol) payable",
      "event OwnershipTransferred(address indexed user, address indexed newOwner)",
      "event Transfer(address indexed from, address indexed to, uint256 indexed id)",
      "function balanceOf(address owner) view returns (uint256)",
      "function burn(uint256 id)",
      "function myAddr() view returns (address)",
      "function name() view returns (string)",
      "function owner() view returns (address)",
      "function ownerOf(uint256 id) view returns (address owner)",
      "function safeBatchMint(address[] to, string[] uris)",
      "function safeMint(address to, string uri)",
      "function supportsInterface(bytes4 interfaceId) view returns (bool)",
      "function symbol() view returns (string)",
      "function tokenURI(uint256 tokenId) view returns (string)",
      "function transferOwnership(address newOwner)",
    ];

    let contractAddress;
    const getAddress = async () => {
      contractAddress = document.getElementById("future_address").innerHTML;
    };

    let provider;
    let wallet;
    let contract;

    async function connectToContract() {
      provider = new ethers.providers.Web3Provider(this.parent.ethereum);
      wallet = provider.getSigner();
      contract = new ethers.Contract(contractAddress, abi, wallet);
      // provider = new ethers.providers.JsonRpcProvider();
      // wallet = new ethers.Wallet(privateKey, provider);
      // contract = new ethers.Contract(contractAddress, abi, wallet);
    }

    setTimeout(() => {
      getAddress();
      connectToContract();
    }, 2100);
  </script>

  <script>
    function shortenAddress(address) {
      if (address.length < 10) return address; // Если адрес слишком короткий, возвращаем его как есть
      return address.slice(0, 6) + "..." + address.slice(-5); // Возвращаем сокращенный адрес
    }

    const customCallToast = (msg) => {
      Toastify({
        text: msg,
        position: "center",
        gravity: "top",
      }).showToast();
    };

    let nfts = [];
    const getNfts = async () => {
      const get_nfts = await contract.queryFilter("Transfer");
      get_nfts.forEach((nft) => {
        nfts.push(nft.args);
      });
    };

    const renderNfts = async () => {
      const section = document.getElementById("nft-cards");
      section.innerHTML = "";
      console.log(nfts.length);
      for (let item in nfts) {
        const nft = nfts[item];
        const id = nft[2];
        try {
          const link = await contract.tokenURI(id);
          if (!link.startsWith("http")) {
            // добавил обработку соженных NFT
            console.log(link);
            if (!link) {
              continue;
            }
            customCallToast(`Invalid link for nft with id: ${id}`);
            continue;
          }
          const res = await fetch(link);
          const json = await res.json();

          const ownerAddress = await contract.ownerOf(id);

          section.innerHTML += `
                    <div class="card max-w-[320px] bg-base-100 shadow-xl">
                        <figure>
                            <img
                                src="${
                                  json.image
                                    ? json.image
                                    : "https://via.assets.so/img.jpg?w=400&h=300&tc=blue&bg=#cecece"
                                }"
                                alt="Shoes"
                                class="max-h-[250px] w-full object-cover"
                            />
                        </figure>
                        <div class="card-body">
                            <h2 class="card-title">${
                              json.name ? json.name : "Name not defined"
                            }</h2>

                            <div class="flex flex-col gap-2 text-xl font-medium">
                                <div class="flex items-center justify-between w-full">
                                    <p>ID:</p> <p class="text-lg font-normal text-end">${id}</p>
                                </div>
                                <div class="flex items-center justify-between w-full">
                                    <p>Owner:</p> <p class="text-lg font-normal text-end">${shortenAddress(
                                      ownerAddress
                                    )}</p>
                                </div>
                            </div>

                            <p>
                                ${
                                  json.description
                                    ? json.description
                                    : "Description not found"
                                }
                            </p>
                        </div>
                    </div>
                </div>
                `;
        } catch (err) {
          customCallToast(`Failed to withdraw nft with id: ${id}`);
        }
      }
    };

    setTimeout(() => {
      getNfts().then(renderNfts);
    }, 3000);
  </script>
</body>

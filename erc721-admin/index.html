<body id="itrf">
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<link href="./build.css" rel="stylesheet"/>
<link href="https://cdn.jsdelivr.net/npm/daisyui@4.10.3/dist/full.min.css" rel="stylesheet" type="text/css"/>
<link
        rel="stylesheet"
        type="text/css"
        href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css"
/>

<p id="future_address" class="hidden invisible"></p>
<div class="p-2 hidden invisible">
    <div class="accordion">
        <div class="accordion-item">
            <section class="m-auto w-100">
                <h3 id="headingOne" class="accordion-header text-center">
                    <button type="button" data-bs-toggle="collapse" data-bs-target="#collapse_myAddr"
                            aria-expanded="true" aria-controls="collapse_myAddr" class="accordion-button collapsed">
                        myAddr
                    </button>
                </h3>
                <div id="collapse_myAddr" aria-labelledby="headingOne" data-bs-parent="#accordionExample"
                     class="accordion-collapse collapse">
                    <div class="accordion-body">
                        <form id="form-myAddr" class="d-flex flex-column gap-2 p-2">
                            <div>
                                <button id="btn" type="button" data-form-name="myAddr" class="btn btn-primary mt-2">
                                    Read
                                </button>
                            </div>
                            <div>
                                <p>Response:
                                </p>
                                <div>:
                                    <span id="form-output-myAddr-0" data-form-name="myAddr" data-field-type="address">address</span>
                                    <br/>
                                </div>
                            </div>

                            <script>
                                setTimeout(() => {
                                        const element = document.getElementById("btn");
                                        if (element) {
                                            element.click();

                                            setTimeout(() => {
                                                const future_address = document.getElementById('future_address')
                                                future_address.innerHTML = document.getElementById('form-output-myAddr-0').innerHTML
                                            }, 1000)
                                        }
                                    }
                                    , 1000);
                            </script>
                        </form>
                    </div>
                </div>
            </section>
        </div>
    </div>
</div>

<section id="loader" class="bg-base-100 flex flex-col items-center pt-20" style="height: 1000px;">
    <svg class="animate-spin fill-white" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
         style="fill: rgba(255, 255, 255, 1);">
        <path d="M12 22c5.421 0 10-4.579 10-10h-2c0 4.337-3.663 8-8 8s-8-3.663-8-8c0-4.336 3.663-8 8-8V2C6.579 2 2 6.58 2 12c0 5.421 4.579 10 10 10z"></path>
    </svg>
    <p class="mt-4 text-xl text-white">Get contract info...</p>
</section>

<section
        id="content"
        data-theme="dark"
        class="pt-20 items-center flex-col gap-10 bg-base-100 hidden"
        style="height: 1000px;"
>

    <h1 class="text-center text-3xl font-extrabold text-white">
        Soulbound Token (ERC721) - Admin
    </h1>
    <div role="tablist" class="tabs tabs-boxed">
        <a
                role="tab"
                id="mint-tab"
                class="tab tab-active transition-all duration-200"
        >
            Mint
        </a>
        <a role="tab" id="burn-tab" class="tab transition-all duration-200">
            Burn
        </a>
        <a role="tab" id="batch-tab" class="tab transition-all duration-200">
            Batch Mint
        </a>
        <a role="tab" id="transfer-tab" class="tab transition-all duration-200">
            Transfer ownership
        </a>
    </div>
    <div id="tab-1" class="custom-card card w-96 bg-base-100 shadow-xl">
        <form id="mint_form" class="card-body flex flex-col space-y-4">
            <div class="flex flex-col gap-2">
                <label for="wallet_address">Wallet address</label>
                <input
                        type="text"
                        id="wallet_address"
                        name="wallet_address"
                        placeholder="Enter address"
                        class="input input-bordered w-full max-w-xs"
                        required
                />
            </div>
            <div class="flex flex-col gap-2">
                <label for="metadata_link">Metadata Link</label>
                <input
                        type="text"
                        id="metadata_link"
                        name="metadata_link"
                        placeholder="Enter metadata link"
                        class="input input-bordered w-full max-w-xs"
                        required
                />
            </div>
            <button class="btn btn-primary">Mint</button>
        </form>
    </div>

    <div id="tab-2" class="custom-card w-96 bg-base-100 shadow-xl hidden">
        <form id="burn_form" class="card-body flex flex-col space-y-4">
            <div class="flex flex-col gap-2">
                <label for="id">ID</label>
                <input
                        type="number"
                        id="id"
                        name="id"
                        placeholder="Enter id to burn"
                        class="input input-bordered w-full max-w-xs"
                        required
                />
            </div>
            <button class="btn btn-primary">Burn</button>
        </form>
    </div>

    <div id="tab-3" class="custom-card w-96 bg-base-100 shadow-xl hidden">
        <form id="batch_form" class="card-body flex flex-col space-y-4">
            <div class="flex flex-col gap-2">
                <div class="flex flex-col gap-2">
                    <label for="id">Addresses</label>
                    <textarea
                            id="addresses"
                            name="addresses"
                            class="textarea textarea-bordered min-h-36 max-h-96"
                            placeholder="Enter your addresses"
                    ></textarea>
                </div>
                <label for="metadata_uri">Metadata Links</label>
                <textarea
                        id="metadata_uri"
                        name="metadata_uri"
                        class="textarea textarea-bordered min-h-36 max-h-96"
                        placeholder="Enter metadata links"
                ></textarea>
            </div>
            <button class="btn btn-primary">Batch</button>
        </form>
    </div>

    <div id="tab-4" class="custom-card w-96 bg-base-100 shadow-xl hidden">
        <form id="transfer_ownership" class="card-body flex flex-col space-y-4">
            <div class="flex flex-col gap-2">
                <label for="t_ownership"
                >Enter the address to whom you want to transfer ownership or leave
                    blank to block access permanently (renounce ownership)</label
                >
                <input
                        type="text"
                        id="t_ownership"
                        name="t_ownership"
                        placeholder="Enter address or leave blank"
                        class="input input-bordered w-full max-w-xs"
                />
            </div>
            <button class="btn btn-primary">Transfer ownership</button>
        </form>
    </div>
</section>

<script>
    const tabs = document.querySelectorAll(".tab");
    const cards = document.querySelectorAll(".custom-card");

    tabs.forEach((tab, index) => {
        tab.addEventListener("click", () => {
            // Remove 'tab-active' class from all tabs
            tabs.forEach((tab) => tab.classList.remove("tab-active"));
            // Add 'tab-active' class to the clicked tab
            tab.classList.add("tab-active");

            // Hide all cards
            cards.forEach((card) => {
                card.classList.add("hidden")
                card.classList.remove("card")
            });
            // Show the corresponding card (index + 1 because index is 0-based)
            document.getElementById(`tab-${index + 1}`).classList.remove("hidden");
            document.getElementById(`tab-${index + 1}`).classList.add("card");
        });
    });
</script>

<script>
    const loader = document.getElementById('loader');
    const content = document.getElementById('content');

    setTimeout(() => {
        loader.classList.add('hidden')
        loader.classList.remove('flex')
        content.classList.add('flex')
        content.classList.remove('hidden')
    }, 3000)
</script>

<script
        src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.12.1/ethers.umd.min.js"
        type="application/javascript"
></script>

<script>
    const abi = [
        {
            inputs: [
                {
                    internalType: "string",
                    name: "_name",
                    type: "string",
                },
                {
                    internalType: "string",
                    name: "_symbol",
                    type: "string",
                },
            ],
            stateMutability: "payable",
            type: "constructor",
        },
        {
            anonymous: false,
            inputs: [
                {
                    indexed: true,
                    internalType: "address",
                    name: "user",
                    type: "address",
                },
                {
                    indexed: true,
                    internalType: "address",
                    name: "newOwner",
                    type: "address",
                },
            ],
            name: "OwnershipTransferred",
            type: "event",
        },
        {
            anonymous: false,
            inputs: [
                {
                    indexed: true,
                    internalType: "address",
                    name: "from",
                    type: "address",
                },
                {
                    indexed: true,
                    internalType: "address",
                    name: "to",
                    type: "address",
                },
                {
                    indexed: true,
                    internalType: "uint256",
                    name: "id",
                    type: "uint256",
                },
            ],
            name: "Transfer",
            type: "event",
        },
        {
            inputs: [
                {
                    internalType: "address",
                    name: "owner",
                    type: "address",
                },
            ],
            name: "balanceOf",
            outputs: [{internalType: "uint256", name: "", type: "uint256"}],
            stateMutability: "view",
            type: "function",
        },
        {
            inputs: [
                {
                    internalType: "uint256",
                    name: "id",
                    type: "uint256",
                },
            ],
            name: "burn",
            outputs: [],
            stateMutability: "payable",
            type: "function",
        },
        {
            inputs: [],
            name: "name",
            outputs: [{internalType: "string", name: "", type: "string"}],
            stateMutability: "view",
            type: "function",
        },
        {
            inputs: [],
            name: "owner",
            outputs: [{internalType: "address", name: "", type: "address"}],
            stateMutability: "view",
            type: "function",
        },
        {
            inputs: [
                {
                    internalType: "uint256",
                    name: "id",
                    type: "uint256",
                },
            ],
            name: "ownerOf",
            outputs: [
                {
                    internalType: "address",
                    name: "owner",
                    type: "address",
                },
            ],
            stateMutability: "view",
            type: "function",
        },
        {
            inputs: [
                {
                    internalType: "address[]",
                    name: "to",
                    type: "address[]",
                },
                {
                    internalType: "string[]",
                    name: "uris",
                    type: "string[]",
                },
            ],
            name: "safeBatchMint",
            outputs: [],
            stateMutability: "payable",
            type: "function",
        },
        {
            inputs: [
                {
                    internalType: "address",
                    name: "to",
                    type: "address",
                },
                {internalType: "string", name: "uri", type: "string"},
            ],
            name: "safeMint",
            outputs: [],
            stateMutability: "payable",
            type: "function",
        },
        {
            inputs: [
                {
                    internalType: "bytes4",
                    name: "interfaceId",
                    type: "bytes4",
                },
            ],
            name: "supportsInterface",
            outputs: [{internalType: "bool", name: "", type: "bool"}],
            stateMutability: "view",
            type: "function",
        },
        {
            inputs: [],
            name: "symbol",
            outputs: [{internalType: "string", name: "", type: "string"}],
            stateMutability: "view",
            type: "function",
        },
        {
            inputs: [
                {
                    internalType: "uint256",
                    name: "tokenId",
                    type: "uint256",
                },
            ],
            name: "tokenURI",
            outputs: [{internalType: "string", name: "", type: "string"}],
            stateMutability: "view",
            type: "function",
        },
        {
            inputs: [
                {
                    internalType: "address",
                    name: "newOwner",
                    type: "address",
                },
            ],
            name: "transferOwnership",
            outputs: [],
            stateMutability: "payable",
            type: "function",
        },
    ];
    let contractAddress;

    const getAddress = async () => {
        setTimeout(() => {
            contractAddress = document.getElementById('future_address').innerHTML
        }, 3000);
    }

    getAddress()

    let provider;
    let signer;
    let connectContract;

    const initApp = async () => {
        provider = new ethers.BrowserProvider(this.parent.ethereum)
        signer = await provider.getSigner()

        connectContract = new ethers.Contract(contractAddress, abi, signer);
        console.log("Account:", await signer.getAddress());
    }
    setTimeout(() => {
        initApp()
    }, 3000)
</script>
<script
        type="text/javascript"
        src="https://cdn.jsdelivr.net/npm/toastify-js"
></script>
<script>
    const mintForm = document.getElementById("mint_form");
    const burnForm = document.getElementById("burn_form");
    const batchForm = document.getElementById("batch_form");
    const transferOwnership = document.getElementById("transfer_ownership");

    transferOwnership.addEventListener("submit", async (event) => {
        event.preventDefault();
        let error = false;
        const formData = new FormData(transferOwnership);
        const to = formData.get("t_ownership");

        if (!to) {
            // ничего не ввел
            try {
                await connectContract.transferOwnership(
                    "0x0000000000000000000000000000000000000000"
                );
                console.log(await connectContract.owner());
                Toastify({
                    text: `Success transferOwnership to null address!`,
                    position: "right",
                    gravity: "top",
                }).showToast();
            } catch (e) {
                console.log(e)
                Toastify({
                    text: `Error call transferOwnership!`,
                    position: "right",
                    gravity: "top",
                }).showToast();
            }
        } else {
            if (!/^0x[a-fA-F0-9]{40}$/.test(to)) {
                Toastify({
                    text: `Wrong address: ${to}`,
                    position: "right",
                    gravity: "top",
                }).showToast();
            }
            console.log(await connectContract.owner());
            error = true;
            if (!error) {
                try {
                    await connectContract.transferOwnership(to);
                    Toastify({
                        text: `Success transferOwnership!`,
                        position: "right",
                        gravity: "top",
                    }).showToast();
                    console.log(await connectContract.owner());
                    transferOwnership.reset()
                } catch (e) {
                    console.log(e)
                    Toastify({
                        text: `Error call transferOwnership!`,
                        position: "right",
                        gravity: "top",
                    }).showToast();
                }
            }
        }
    });

    mintForm.addEventListener("submit", async (event) => {
        event.preventDefault();
        let error = false;
        const formData = new FormData(mintForm);
        const uri = formData.get("metadata_link");
        const to = formData.get("wallet_address");

        if (!/^0x[a-fA-F0-9]{40}$/.test(to)) {
            Toastify({
                text: `Wrong address: ${to}`,
                className: "error",
                position: "right",
                gravity: "top",
            }).showToast();
            error = true;
        }
        if (!error) {
            try {
                await connectContract.safeMint(to, uri);
                mintForm.reset();
                Toastify({
                    text: `Successfull mint!`,
                    position: "right",
                    gravity: "top",
                }).showToast();
            } catch (e) {
                console.log(e)
                Toastify({
                    text: `Error call safeMint`,
                    position: "right",
                    gravity: "top",
                }).showToast();
            }
        }
    });

    // сжигает в локалке
    burnForm.addEventListener("submit", async (event) => {
        event.preventDefault();
        const formData = new FormData(burnForm);
        const id = formData.get("id");

        try {
            await connectContract.burn(id);
            burnForm.reset();
            Toastify({
                text: `Successfull burn!`,
                position: "right",
                gravity: "top",
            }).showToast();
        } catch (e) {
            console.log(e)
            Toastify({
                text: `Error call burn!`,
                position: "right",
                gravity: "top",
            }).showToast();
        }
    });

    batchForm.addEventListener("submit", async (event) => {
        event.preventDefault();
        let error = false;
        const formData = new FormData(batchForm);
        let walletsData = formData.get("addresses");
        const walletsArray = walletsData
            .split("\n")
            .map((wallet) => wallet.trim())
            .filter((wallet) => wallet.trim() !== "");

        walletsArray.forEach((wallet, index) => {
            if (!/^0x[a-fA-F0-9]{40}$/.test(wallet)) {
                Toastify({
                    text: `Wrong address: ${wallet}`,
                    className: "error",
                    position: "right",
                    gravity: "top",
                }).showToast();
                error = true;
            }
        });

        const uniqueWalletsArray = Array.from(new Set(walletsArray)); // без дубликатов массив

        const metadata_links = formData.get("metadata_uri");
        const urisArray = metadata_links.split("\n");

        if (uniqueWalletsArray.length != urisArray.length) {
            Toastify({
                text: `The number of addresses and links did not match! Check again, there may be duplicates!`,
                position: "right",
                gravity: "top",
            }).showToast();
            error = true;
        }

        if (!error) {
            try {
                await connectContract.safeBatchMint(uniqueWalletsArray, urisArray);
                batchForm.reset()
                Toastify({
                    text: `The number of addresses and links did not match! Check again, there may be duplicates!`,
                    position: "right",
                    gravity: "top",
                }).showToast();
            } catch (e) {
                console.log(e)
                Toastify({
                    text: `Error call safeBatchMint`,
                    position: "right",
                    gravity: "top",
                }).showToast();
            }
        }
    });
</script>
</body>
